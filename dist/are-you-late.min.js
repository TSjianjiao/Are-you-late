(()=>{var e={852:function(e,t,n){e.exports=function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=t(e),s={name:"zh-cn",weekdays:"星期日_星期一_星期二_星期三_星期四_星期五_星期六".split("_"),weekdaysShort:"周日_周一_周二_周三_周四_周五_周六".split("_"),weekdaysMin:"日_一_二_三_四_五_六".split("_"),months:"一月_二月_三月_四月_五月_六月_七月_八月_九月_十月_十一月_十二月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),ordinal:function(e,t){switch(t){case"W":return e+"周";default:return e+"日"}},weekStart:1,yearStart:4,formats:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY/MM/DD",LL:"YYYY年M月D日",LLL:"YYYY年M月D日Ah点mm分",LLLL:"YYYY年M月D日ddddAh点mm分",l:"YYYY/M/D",ll:"YYYY年M月D日",lll:"YYYY年M月D日 HH:mm",llll:"YYYY年M月D日dddd HH:mm"},relativeTime:{future:"%s内",past:"%s前",s:"几秒",m:"1 分钟",mm:"%d 分钟",h:"1 小时",hh:"%d 小时",d:"1 天",dd:"%d 天",M:"1 个月",MM:"%d 个月",y:"1 年",yy:"%d 年"},meridiem:function(e,t){var n=100*e+t;return n<600?"凌晨":n<900?"早上":n<1100?"上午":n<1300?"中午":n<1800?"下午":"晚上"}};return n.default.locale(s,null,!0),s}(n(349))},607:function(e){e.exports=function(){"use strict";return function(e,t,n){t.prototype.isBetween=function(e,t,s,i){var o=n(e),a=n(t),r="("===(i=i||"()")[0],u=")"===i[1];return(r?this.isAfter(o,s):!this.isBefore(o,s))&&(u?this.isBefore(a,s):!this.isAfter(a,s))||(r?this.isBefore(o,s):!this.isAfter(o,s))&&(u?this.isAfter(a,s):!this.isBefore(a,s))}}}()},903:function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,o){function a(e){try{u(s.next(e))}catch(e){o(e)}}function r(e){try{u(s.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,r)}u((s=s.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=i(n(522)),a=i(n(841)),r=i(n(391)),u=n(836),l=i(n(94)),d=i(n(68)),c=i(n(90)),f=n(224),m=i(n(418)),p=n(461),h=i(n(224)),g=i(n(349)),y=i(n(607));n(852);const v=i(n(585)),_=i(n(814)),b=i(n(640)),q=/迟到/gi,M=/不迟到|没有迟到|不会迟到|不可能迟到|没迟到|准时到|准点到|迟不到/gi;g.default.extend(y.default),p.EventFlow.saveFlashImage=e=>s(void 0,void 0,void 0,(function*(){var t,n;const{message:s}=e,i=null===(n=null===(t=null==s?void 0:s.data)||void 0===t?void 0:t.messageChain)||void 0===n?void 0:n.find((e=>"FlashImage"===e.type));if(null==i?void 0:i.url){const e=s.data.sender.id;_.default.create({qq:e,url:i.url})}})),p.EventFlow.addUser=e=>s(void 0,void 0,void 0,(function*(){var t,n;const{message:s}=e;if(null===(n=null===(t=null==s?void 0:s.data)||void 0===t?void 0:t.sender)||void 0===n?void 0:n.id){const{data:{sender:{id:e,memberName:t,specialTitle:n}}}=s;yield l.default.findOneAndUpdate({qq:s.data.sender.id},{qq:s.data.sender.id,memberName:t,specialTitle:n},{upsert:!0}).exec()}})),p.EventFlow.saveYuLiuMessage=e=>s(void 0,void 0,void 0,(function*(){const{message:t,targetQQ:n,commandText:s,text:i}=e;g.default().isBetween(g.default().set("hours",8).set("minutes",0).set("seconds",0),v.default.封盘时间())&&n===o.default.yuliu_qq&&b.default.saveMsg(i)})),p.EventFlow.filter=e=>{var t,n,s,i;const{message:a}=e,u=r.default.get(a).filterByMessageChainType("GroupMessage").filterByMessageType("At").filterByTaget(o.default.bot_qq).filterByPlainText((e=>e.trim().includes("#"))).exec();e.commandMessage=u,e.commandText=null!==(i=null===(s=null===(n=null===(t=null==u?void 0:u.data)||void 0===t?void 0:t.messageChain)||void 0===n?void 0:n.find((e=>"Plain"===e.type)))||void 0===s?void 0:s.text)&&void 0!==i?i:""},p.EventFlow.findFlashImage=e=>s(void 0,void 0,void 0,(function*(){const{message:t,targetQQ:n,commandText:s}=e,[i,a]=u.getParamCommand(s);if("查询闪照"===i)try{const e=5;if(!a)throw new Error("\n请输入正确QQ号");const t=yield _.default.find({qq:a}).sort({createTime:"desc"}).limit(e).exec();if(t.length<=0)throw new Error("\n没有数据");let n="";throw n=t.reduce(((e,t,n)=>e+`\n${g.default(t.createTime).format("YYYY-MM-DD")}：${t.url}`),""),new Error(`\n<${a}>的最近${e}张闪照地址：`+n)}catch({message:t}){r.default.send("sendGroupMessage",o.default.group_qq).plain(t).exec()}})),p.EventFlow.bet=e=>s(void 0,void 0,void 0,(function*(){const{message:t,targetQQ:n,commandText:s}=e,[i,a]=u.isBetCommand(s);if(i&&a){const e=i.search(M)>=0?f.betType.不迟到:i.search(q)>=0?f.betType.迟到:void 0;if(void 0===e)return;const{success:t,message:s}=yield h.default.bet(e,n,Number(a));if(s)return void r.default.send("sendGroupMessage",o.default.group_qq).at(n).plain("\n"+s).face(void 0,"请").exec();r.default.send("sendGroupMessage",o.default.group_qq).at(n).plain(`\n押注${f.betTypeText[e]}：${a}积分`).face(void 0,"吃糖").exec()}})),p.EventFlow.queryPoints=e=>s(void 0,void 0,void 0,(function*(){const{message:t,targetQQ:n,commandText:s}=e;if(u.isQueryPoints(s)){const e=yield c.default.findByQQ(n);if(e)return void r.default.send("sendGroupMessage",o.default.group_qq).at(n).plain(`\n当前还剩${e.remainPoints}积分\n${e.remainPoints<10?"穷逼！":e.remainPoints>1e3?"增有钱呐":""}`).exec();r.default.send("sendGroupMessage",o.default.group_qq).at(n).plain("\n没有记录，发送 #签到 试试？").exec()}})),p.EventFlow.signIn=e=>s(void 0,void 0,void 0,(function*(){const{message:t,targetQQ:n,commandText:s}=e;if(u.isSignInCommand(s)){const e=m.default(),t=yield c.default.findByQQ(n),{success:s,message:i}=yield d.default.signIn(n,e);if(s){const{success:s,message:i}=yield t.addPoint(e);r.default.send("sendGroupMessage",o.default.group_qq).at(n).plain(s?`\n签到成功！\n获得积分${e}!\n${e<=5?"maybe!":""}`:`\n签到失败：\n${i}`).exec()}else r.default.send("sendGroupMessage",o.default.group_qq).at(n).plain(`\n签到失败：${i}`).exec()}})),p.EventFlow.queryBet=e=>s(void 0,void 0,void 0,(function*(){var t,n,s,i,a,l,d,c;const{message:m,targetQQ:p,commandText:y,commandMessage:_}=e;if(u.isQueryBet(y)){const e=yield h.default.aggregate([{$facet:{late:[{$match:{betTime:{$gt:g.default().startOf("date").toDate(),$lt:v.default.封盘时间().toDate()},betType:{$eq:f.betType.迟到}}},{$group:{_id:"null",betPoints:{$sum:"$betPoint"},betNum:{$sum:1},betUser:{$push:{qq:"$qq",betPoint:"$betPoint"}}}},{$project:{_id:0,betPoints:1,betNum:1,betUser:1}}],notLate:[{$match:{betTime:{$gt:g.default().startOf("date").toDate(),$lt:v.default.封盘时间().toDate()},betType:{$eq:f.betType.不迟到}}},{$group:{_id:"null",betPoints:{$sum:"$betPoint"},betNum:{$sum:1},betUser:{$push:{qq:"$qq",betPoint:"$betPoint"}}}},{$project:{_id:0,betPoints:1,betNum:1,betUser:1}}],targetUserBet:[{$match:{betTime:{$gt:g.default().startOf("date").toDate(),$lt:v.default.封盘时间().toDate()},qq:{$eq:String(p)}}},{$project:{betPoint:1,betTime:1,betType:1}}]}}]).exec(),u=null!==(n=null===(t=e[0].late[0])||void 0===t?void 0:t.betPoints)&&void 0!==n?n:0,m=null!==(i=null===(s=e[0].notLate[0])||void 0===s?void 0:s.betPoints)&&void 0!==i?i:0,y=u+m,_=null!==(l=null===(a=e[0].late[0])||void 0===a?void 0:a.betNum)&&void 0!==l?l:0,b=null!==(c=null===(d=e[0].notLate[0])||void 0===d?void 0:d.betNum)&&void 0!==c?c:0;let q;if(e[0].targetUserBet[0]){const{betPoint:t,betTime:n,betType:s}=e[0].targetUserBet[0];q=s===f.betType.迟到?Math.floor(t/u*y):Math.floor(t/m*y)}r.default.send("sendGroupMessage",o.default.group_qq).at(p).plain(`\n      今日投注情况：\n      迟到：${u}积分（${_}人）\n      不迟到：${m}积分（${b}人）\n      ${q?`<${p}>已投注<${f.betTypeText[e[0].targetUserBet[0].betType]}>预计可获得：${q}积分`:""}\n      `).exec()}})),p.EventFlow.accountBet=e=>s(void 0,void 0,void 0,(function*(){var t,n,s,i;const{message:l,targetQQ:d,commandMessage:m}=e,p=r.default.get(m).filterBySender([o.default.admin_qq,o.default.yuliu_qq]).exec(),[y,_]=u.getParamCommand(null!==(i=null===(s=null===(n=null===(t=null==p?void 0:p.data)||void 0===t?void 0:t.messageChain)||void 0===n?void 0:n.find((e=>"Plain"===e.type)))||void 0===s?void 0:s.text)&&void 0!==i?i:"");if("结算"===y){let e=_.search(M)>=0?f.betType.不迟到:_.search(q)>=0?f.betType.迟到:void 0;const t=yield h.default.aggregate([{$match:{betTime:{$gt:g.default().startOf("date").toDate(),$lt:v.default.封盘时间().toDate()}}},{$lookup:{from:"gameusers",let:{qq:"$qq"},pipeline:[{$match:{$expr:{$eq:["$$qq","$qq"]}}},{$project:{_id:0,memberName:1,specialTitle:1}},{$lookup:{from:"userpoints",pipeline:[{$match:{$expr:{$eq:["$$qq","$qq"]}}}],as:"userpoints"}},{$unwind:{path:"$userpoints"}},{$replaceRoot:{newRoot:{$mergeObjects:["$userpoints","$$ROOT"]}}},{$project:{_id:0,memberName:1,remainPoints:1,specialTitle:1,totalPoints:1}}],as:"gameusers"}},{$unwind:{path:"$gameusers"}}]).exec();if(t.length<=0)return void r.default.send("sendGroupMessage",o.default.group_qq).at(d).plain("今天还没有人下注").exec();const n=t[0].betState!==f.betState.未结束;e=n?t[0].betState:e;let s=0,i=0,u=0;t.forEach((e=>{s+=e.betPoint,e.betType===f.betType.迟到?i+=e.betPoint:u+=e.betPoint}));const l=t=>{const{betPoint:o,betType:a,betProfit:r}=t;return n?r:a===f.betType.不迟到?e===a||void 0===e?Math.floor(o/u*s):0:e===a||void 0===e?Math.floor(o/i*s):0};let m='\n请输入"迟到"或者"没有迟到"';const p=[];if(t.length>0){const e=new a.default;t.forEach((function(t){const s=l(t);p.push(Object.assign(Object.assign({},t),{betProfit:s})),e.cell("昵称",t.gameusers.memberName),e.cell("投注类型",f.betTypeText[t.betType]),e.cell("投注积分",t.betPoint),e.cell("剩余积分",t.gameusers.remainPoints),e.cell(n?"获得积分":"预计得分",s)})),m=e.output()}void 0===e||n||p.forEach((e=>{c.default.updateOne({qq:e.qq},{$inc:{remainPoints:e.betProfit}}).exec(),h.default.updateOne({qq:e.qq},{$set:{betState:e.betType,betProfit:e.betProfit}}).exec()})),r.default.send("sendGroupMessage",o.default.group_qq).at(d).plain("\n"+(n||void 0!==e?`已结算<${f.betTypeText[e]||f.betStateText[t[0].betState]}>`:"未结算")+"\n"+m+"\n").exec()}})),p.EventFlow.pointsRank=e=>s(void 0,void 0,void 0,(function*(){const{message:t,targetQQ:n,commandText:s}=e;if(u.isCommand(s,/积分排行/gi)){const e=yield c.default.aggregate([{$sort:{remainPoints:-1}},{$lookup:{from:"gameusers",let:{qq:"$qq"},as:"gameusers",pipeline:[{$match:{$expr:{$eq:["$$qq","$qq"]}}},{$project:{_id:0,memberName:1,specialTitle:1}}]}},{$unwind:{path:"$gameusers"}},{$project:{_id:0,qq:1,totalPoints:1,remainPoints:1,gameusers:1}}]).exec(),t=new a.default,n=e.length,s=5;let i=0,u=1;for(;i<n;){e.slice(i,i+=s).forEach(((e,n)=>{t.cell("排名",u++),t.cell("昵称",e.gameusers.memberName),t.cell("剩余积分",e.remainPoints),t.cell("总获得积分",e.totalPoints)}));let n=t.output();r.default.send("sendGroupMessage",o.default.group_qq).plain("\n"+n+"\n").exec()}}})),p.EventFlow.queryMaybe=e=>s(void 0,void 0,void 0,(function*(){const{message:t,targetQQ:n,commandMessage:s,commandText:i}=e,[a,l]=u.getParamCommand(i);let c=g.default();if("查询眉笔"===a){l&&g.default(l).isValid()&&(c=g.default(l));const e=yield d.default.find({signInTime:{$gt:c.startOf("date").toDate(),$lt:c.endOf("date").toDate()},point:{$lt:5}}).sort({point:1}).exec();e.length>0?r.default.send("sendGroupMessage",o.default.group_qq).plain(`${c.format("MM[月]DD[日]")}的眉笔是\n`).at(e[0].qq).plain(`\nta通过努力签到获得了${e[0].point}分！\n`).plain("\n让我们恭喜ta").face(void 0,"庆祝").face(void 0,"庆祝").exec():r.default.send("sendGroupMessage",o.default.group_qq).plain(`${c.format("MM[月]DD[日]")}没有眉笔\n`).exec()}})),p.EventFlow.help=e=>s(void 0,void 0,void 0,(function*(){const{message:t,targetQQ:n,commandText:s,commandMessage:i}=e;if(u.isCommand(s,/命令/gi)){let e="";for(let t in u.commandList)e+=`\n${t}：${u.commandList[t]}`;r.default.send("sendGroupMessage",o.default.group_qq).at(n).plain(e).exec()}}))},585:function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=s(n(349));function o(){return i.default().set("hours",9).set("minutes",30).set("seconds",0)}const a={迟到扣钱:30,上班时间:o,封盘时间:function(){return o().subtract(10,"minute")}};t.default=a},692:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default={uri:"mongodb://admin:xh19963900@127.0.0.1:27017",connectionOptions:{useNewUrlParser:!0,useUnifiedTopology:!0,dbName:"areyoulate"}}},8:function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=s(n(622));t.default={appenders:{defualt:{type:"file",filename:i.default.join(__dirname,"../log/defualt.log"),layout:{type:"coloured"}},errors:{type:"dateFile",category:"dateFileLog",filename:i.default.join(__dirname,"../log/errors/"),pattern:"yyyy-MM-dd.log",alwaysIncludePattern:!0,layout:{type:"coloured"}},ws:{type:"file",filename:i.default.join(__dirname,"../log/ws.log"),layout:{type:"coloured"}},db:{type:"file",filename:i.default.join(__dirname,"../log/db.log"),layout:{type:"coloured"}}},categories:{default:{appenders:["defualt"],level:"info"},error:{appenders:["errors"],level:"error"},ws:{appenders:["ws"],level:"info"},db:{appenders:["db"],level:"info"}}}},522:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n={wsPath:"ws://172.17.82.247:3002",httpPath:"http://172.17.82.247:3001",verifyKey:1234567890,bot_qq:"1092946821",group_qq:"599869861",admin_qq:"929175050",yuliu_qq:"1916300010"};t.default=n},40:function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=s(n(619)),o=s(n(692)),a=s(n(514));i.default.set("useFindAndModify",!1),i.default.connect(o.default.uri,o.default.connectionOptions,(e=>{e?(console.log("[Mongoose🦢] 连接失败"),a.default("db","error",e)):(console.log("[Mongoose🦢] 连接成功"),a.default("db","info","[Mongoose🦢] 连接成功"))})),t.default=i.default},224:function(e,t,n){"use strict";var s=this&&this.__decorate||function(e,t,n,s){var i,o=arguments.length,a=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,s);else for(var r=e.length-1;r>=0;r--)(i=e[r])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,o){function a(e){try{u(s.next(e))}catch(e){o(e)}}function r(e){try{u(s.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,r)}u((s=s.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.betStateText=t.betState=t.betTypeText=t.betType=void 0;const r=a(n(585)),u=a(n(727)),l=n(551),d=a(n(349)),c=n(619),f=a(n(90));var m,p;!function(e){e[e["迟到"]=0]="迟到",e[e["不迟到"]=1]="不迟到"}(m=t.betType||(t.betType={})),t.betTypeText={[m.迟到]:"迟到",[m.不迟到]:"不迟到"},function(e){e[e["迟到"]=0]="迟到",e[e["不迟到"]=1]="不迟到",e[e["未结束"]=2]="未结束"}(p=t.betState||(t.betState={})),t.betStateText={[p.迟到]:"迟到",[p.不迟到]:"不迟到",[p.未结束]:"未结束"};const h=new c.Schema({qq:{type:c.Schema.Types.String,required:!0},betPoint:{type:c.Schema.Types.Number,require:!1,validate:{validator:function(e){return e<0&&l.thorwCustomError("只能投注正数"),Number.isInteger(e)||l.thorwCustomError("只能投注整数"),!0}},default:()=>0},betTime:{type:c.Schema.Types.Date,require:!1,default:()=>d.default().toDate()},betType:{type:c.Schema.Types.Number,require:!1},betState:{type:c.Schema.Types.Number,require:!1,default:()=>p.未结束},betProfit:{type:c.Schema.Types.Number,require:!1,default:()=>0}});class g{static bet(e,n,s){return o(this,void 0,void 0,(function*(){d.default().isAfter(r.default.封盘时间())&&l.thorwCustomError(`每天 ${r.default.封盘时间().format("HH:mm:ss")} 前可投注！`),(s<=0||!Number.isInteger(s))&&l.thorwCustomError("只能为正整数");const i=yield this.findByQQ(n,{betTime:{$gt:d.default().startOf("date").toDate(),$lt:r.default.封盘时间().toDate()}}),o=yield f.default.findByQQ(n);i&&void 0!==(null==i?void 0:i.betType)&&i.betType!==e&&l.thorwCustomError(`你已认定摆子哥 ${t.betTypeText[i.betType]}了!改不了咯~`),o.remainPoints>=s?(yield i.updateOne({$inc:{betPoint:s},betTime:d.default().toDate(),betType:e}).exec(),yield o.updateOne({$inc:{remainPoints:-s}}).exec()):l.thorwCustomError("你没有足够的积分！穷逼!")}))}static findByQQ(e,t){return o(this,void 0,void 0,(function*(){const n=yield this.findOne(Object.assign({qq:e},t)).exec();return n||(yield this.create({qq:e,betState:p.未结束}))}))}}s([u.default(),i("design:type",Function),i("design:paramtypes",[Number,String,Number]),i("design:returntype",Promise)],g,"bet",null),h.loadClass(g);const y=c.model("Bet",h);t.default=y},814:function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=s(n(349)),o=n(619),a=new o.Schema({qq:{type:o.Schema.Types.String,required:!0},url:{type:o.Schema.Types.String,require:!0},createTime:{type:o.Schema.Types.String,require:!1,default:()=>i.default().toDate()}});a.loadClass(class{});const r=o.model("FlashImage",a);t.default=r},94:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(619),i=new s.Schema({qq:{type:s.Schema.Types.String,required:!0},memberName:{type:s.Schema.Types.String,require:!0},specialTitle:{type:s.Schema.Types.String,require:!0}});t.default=s.models&&s.models.GameUser||s.model("GameUser",i)},68:function(e,t,n){"use strict";var s=this&&this.__decorate||function(e,t,n,s){var i,o=arguments.length,a=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,s);else for(var r=e.length-1;r>=0;r--)(i=e[r])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,o){function a(e){try{u(s.next(e))}catch(e){o(e)}}function r(e){try{u(s.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,r)}u((s=s.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=a(n(727)),u=n(551),l=a(n(349)),d=n(619),c=new d.Schema({qq:{type:d.Schema.Types.String,required:!0},signInTime:{type:d.Schema.Types.Date,require:!1,default:()=>l.default().toDate()},point:{type:d.Schema.Types.Number,require:!0}});class f{static signIn(e,t){return o(this,void 0,void 0,(function*(){(yield this.findOne({qq:e,signInTime:{$gt:l.default().startOf("date").toDate()}}).exec())?u.thorwCustomError("今天已签到"):yield this.create({qq:e,point:null!=t?t:0})}))}}s([r.default(),i("design:type",Function),i("design:paramtypes",[String,Number]),i("design:returntype",Promise)],f,"signIn",null),c.loadClass(f);const m=d.model("SignIn",c);t.default=m},90:function(e,t,n){"use strict";var s=this&&this.__decorate||function(e,t,n,s){var i,o=arguments.length,a=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,s);else for(var r=e.length-1;r>=0;r--)(i=e[r])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,o){function a(e){try{u(s.next(e))}catch(e){o(e)}}function r(e){try{u(s.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,r)}u((s=s.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(619),u=a(n(727)),l=n(551),d=new r.Schema({qq:{type:r.Schema.Types.String,required:!0},totalPoints:{type:r.Schema.Types.Number,require:!1,validate:{validator:function(e){return e<0&&l.thorwCustomError("不能再减少"),Number.isInteger(e)||l.thorwCustomError("只能为整数"),!0}},default:()=>0},remainPoints:{type:r.Schema.Types.Number,require:!1,validate:{validator:function(e){return e<0&&l.thorwCustomError("不能再减少"),Number.isInteger(e)||l.thorwCustomError("只能为整数"),!0}},default:()=>0}});class c{addPoint(e){return o(this,void 0,void 0,(function*(){this.updateOne({$inc:{totalPoints:e,remainPoints:e}}).exec()}))}subPoint(e){return o(this,void 0,void 0,(function*(){const t=this.remainPoints-e;yield this.updateOne({remainPoints:t<0?0:t}).exec()}))}static findByQQ(e){return o(this,void 0,void 0,(function*(){const t=yield this.findOne({qq:e}).exec();return t||(yield this.create({qq:e}))}))}}s([u.default("添加积分失败！"),i("design:type",Function),i("design:paramtypes",[Number]),i("design:returntype",Promise)],c.prototype,"addPoint",null),s([u.default("减少积分失败！"),i("design:type",Function),i("design:paramtypes",[Number]),i("design:returntype",Promise)],c.prototype,"subPoint",null),d.loadClass(c);const f=r.model("UserPoints",d);t.default=f},640:function(e,t,n){"use strict";var s=this&&this.__decorate||function(e,t,n,s){var i,o=arguments.length,a=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,s);else for(var r=e.length-1;r>=0;r--)(i=e[r])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,o){function a(e){try{u(s.next(e))}catch(e){o(e)}}function r(e){try{u(s.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,r)}u((s=s.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=a(n(727)),u=a(n(349)),l=n(619),d=new l.Schema({msg:{type:l.Schema.Types.String,required:!0},saveTime:{type:l.Schema.Types.Date,require:!1,default:()=>u.default().toDate()}});class c{static saveMsg(e){return o(this,void 0,void 0,(function*(){e&&(yield this.create({msg:e}))}))}}s([r.default(),i("design:type",Function),i("design:paramtypes",[String]),i("design:returntype",Promise)],c,"saveMsg",null),d.loadClass(c);const f=l.model("YuliuMsg",d);t.default=f},718:function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.store=void 0;const i=n(139),o=s(n(578));t.store=i.configureStore({reducer:{session:o.default}})},578:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.saveSession=t.sessionSlice=void 0;const s=n(139);t.sessionSlice=s.createSlice({name:"session",initialState:{session:""},reducers:{saveSession:(e,t)=>{e.session=t.payload}}}),t.saveSession=t.sessionSlice.actions.saveSession,t.default=t.sessionSlice.reducer},768:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CodeEnum=t.CodeText=void 0,t.CodeText={0:"正常",1:"错误的verify key",2:"指定的Bot不存在",3:"Session失效或不存在",4:"Session未认证(未激活)",5:"发送消息目标不存在(指定对象不存在)",6:"指定文件不存在，出现于发送本地图片",10:"无操作权限，指Bot没有对应操作的限权",11:"Bot被禁言，指Bot当前无法向指定群发送消息",30:"消息过长",400:"错误的访问，如参数错误等"},function(e){e[e.success=0]="success",e[e.errorVerifyKey=1]="errorVerifyKey",e[e.noBot=2]="noBot",e[e.sessionNotExsist=3]="sessionNotExsist",e[e.sessionNotActive=4]="sessionNotActive",e[e.targetLost=5]="targetLost",e[e.fileLost=6]="fileLost",e[e.permissionDeny=10]="permissionDeny",e[e.forbiddenWords=11]="forbiddenWords",e[e.longMessage=30]="longMessage",e[e.error=400]="error"}(t.CodeEnum||(t.CodeEnum={}))},836:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isQueryBet=t.isQueryPoints=t.isSignInCommand=t.isBetCommand=t.getParamCommand=t.isCommand=t.commandList=void 0,t.commandList={投注:"#[迟到 | 没迟到] [投注点数]",查询积分:"#查询积分",签到:"#签到",查询投注:"#查询投注",结算:"#结算 [迟到 | 没迟到]"},t.isCommand=function(e,t){if(!e)return;const n=e.split("#");return t instanceof RegExp?t.test(n[1]):n[1]===t},t.getParamCommand=function(e){if(!e)return["",""];const t=e.split("#");if(2===t.length){const e=t[1].split(" ");if(2===e.length){const[t,n]=e;return[t,n]}return[e[0],""]}return["",""]},t.isBetCommand=function(e){if(!e)return["",""];const t=e.split("#");if(2===t.length){const e=t[1].split(" ");if(2===e.length){const[t,n]=e;if(!isNaN(Number(n)))return[t,n]}}return["",""]},t.isSignInCommand=function(e){if(!e)return;const t=/签到$/gi,n=e.split("#");return!(2!==n.length||!t.test(n[1]))},t.isQueryPoints=function(e){if(!e)return;return"查询积分"===e.split("#")[1]},t.isQueryBet=function(e){if(!e)return;return"查询投注"===e.split("#")[1]}},580:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){return function(e,t,n){const s=n.value;n.value=function(...e){const n=this.actionList.length;return this.actionList.push({methodName:t,params:e,method:()=>{let t;n>0?this.filteredMsg&&(t=Object.assign({},this.filteredMsg)):t=Object.assign({},this.msg),s.apply(this,[...e,t])}}),this}}}},727:function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,o){function a(e){try{u(s.next(e))}catch(e){o(e)}}function r(e){try{u(s.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,r)}u((s=s.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(551),a=i(n(514));t.default=function(e){return function(t,n,i){const r=i.value;i.value=function(...t){return s(this,void 0,void 0,(function*(){try{return yield r.call(this,...t),{success:!0}}catch(t){return t.name!==o.ErrorNames.custom&&a.default("db","error",t),{message:e||t.message}}}))}}}},551:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.thorwCustomError=t.ErrorNames=void 0,t.ErrorNames={custom:"custom"},t.thorwCustomError=function(e){const t=new Error(e);throw t.name="custom",t}},514:function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=s(n(455)),o=s(n(8));i.default.configure(o.default),t.default=function(e,t,n){i.default.getLogger(e)[t](n)}},418:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=100;function s(e,t){return Math.round(e+Math.random()*(t-e))}t.default=()=>Math.random()>=1-1/s(2,3)?s(1,n/s(7,10)):Math.random()>=1-1/s(3,5)?s(1,n/s(5,7)):Math.random()>=1-1/s(5,7)?s(1,n/s(3,5)):s(1,n)},372:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getSession=void 0;const s=n(718),i=n(578),o=n(551);t.getSession=function(e){const{session:t}=s.store.getState().session;return t||(e?(s.store.dispatch(i.saveSession(e.data.session)),e.data.session):void o.thorwCustomError("no session!"))}},841:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToDBC=void 0;function n(e){let t="";for(let n=0;n<e.length;n++)32!=e.charCodeAt(n)?e.charCodeAt(n)<127?t+=String.fromCharCode(e.charCodeAt(n)+65248):t+=e[n]:t+=String.fromCharCode(12288);return t}t.ToDBC=n,t.default=class{constructor(e=[],t="　",n=[],s=0){this.cells=e,this.fullWidthSpace=t,this.columns=n,this.maxRows=s}detectValue(e){const t=e.length;return{width:t,isFullWidth:e.length!==t}}calculateColMaxWidth(){this.columns.forEach((e=>{let t=0;const n=e.colName.length;this.maxRows=e.colValues.length>this.maxRows?e.colValues.length:this.maxRows,e.colValues.forEach((e=>{const n=String(e).length;t=n>t?n:t})),t=n>t?n:t,e.maxWidth=t}))}cell(e,t,s){const i=n(String(t));this.cells.push({colName:e,colValue:i,detectedResult:this.detectValue(i)});const o=this.columns.find((t=>t.colName===e));o?o.colValues.push(i):this.columns.push({colName:e,colValues:[i]})}renderRow(){let e="";const t=this.maxRows;for(let n=-2;n<t;n++)this.columns.forEach(((t,s)=>{let i="";i=-2===n?t.colName:-1===n?"＝".repeat(t.maxWidth):String(t.colValues[n]),e+=i,e+=this.fullWidthSpace.repeat(t.maxWidth+2-i.length)})),e+="\n";return e}output(){this.calculateColMaxWidth();const e=this.renderRow();return this.reset(),e}reset(){this.cells=[],this.columns=[],this.maxRows=0}}},116:function(e,t,n){"use strict";var s=this&&this.__decorate||function(e,t,n,s){var i,o=arguments.length,a=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,s);else for(var r=e.length-1;r>=0;r--)(i=e[r])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=o(n(580));class r{constructor(e){this.msg=e,this.actionList=[]}filterByMessageChainType(e,t){return t&&(t.data.type===e?this.filteredMsg=t:this.filteredMsg=void 0),this}filterByMessageType(e,t){return t&&(t.data.messageChain&&t.data.messageChain.some((t=>t.type===e))?this.filteredMsg=t:this.filteredMsg=void 0),this}filterBySender(e,t){var n,s;return t&&(Array.isArray(e)?e.some((e=>{var n,s;return e===String(null===(s=null===(n=null==t?void 0:t.data)||void 0===n?void 0:n.sender)||void 0===s?void 0:s.id)}))?this.filteredMsg=t:this.filteredMsg=void 0:String(null===(s=null===(n=null==t?void 0:t.data)||void 0===n?void 0:n.sender)||void 0===s?void 0:s.id)===e?this.filteredMsg=t:this.filteredMsg=void 0),this}filterByTaget(e,t){if(!(t&&t.data.messageChain&&t.data.messageChain.some((t=>String(t.target)===e))))return this.filteredMsg=void 0,this;this.filteredMsg=t}filterByPlainText(e,t){if(t&&t.data.messageChain){const n=t.data.messageChain.find((t=>"Plain"===t.type&&e(t.text)));this.filteredMsg=n?t:void 0}return this}exec(){return this.actionList.forEach((e=>{e.method()})),this.actionList=[],this.filteredMsg}}s([a.default(),i("design:type",Function),i("design:paramtypes",[Object,Object]),i("design:returntype",void 0)],r.prototype,"filterByMessageChainType",null),s([a.default(),i("design:type",Function),i("design:paramtypes",[Object,Object]),i("design:returntype",void 0)],r.prototype,"filterByMessageType",null),s([a.default(),i("design:type",Function),i("design:paramtypes",[Object,Object]),i("design:returntype",void 0)],r.prototype,"filterBySender",null),s([a.default(),i("design:type",Function),i("design:paramtypes",[String,Object]),i("design:returntype",void 0)],r.prototype,"filterByTaget",null),s([a.default(),i("design:type",Function),i("design:paramtypes",[Function,Object]),i("design:returntype",void 0)],r.prototype,"filterByPlainText",null),t.default=r},461:function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,o){function a(e){try{u(s.next(e))}catch(e){o(e)}}function r(e){try{u(s.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,r)}u((s=s.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.EventFlow=void 0;const o=i(n(439)),a=i(n(522)),r=i(n(514)),u=n(768),l=n(372);t.EventFlow={};class d{static getWS(){return d.WSInstance?d.WSInstance:d.createWS()}static createWS(){const e=new o.default(`${a.default.wsPath}/all?verifyKey=${a.default.verifyKey}&qq=${a.default.bot_qq}`);return e.on("open",(function(){console.log("websocket连接成功！"),r.default("ws","info","连接成功！")})),e.on("error",(e=>{console.log("websocket错误"),r.default("error","error",e),this.reconnect()})),e.on("close",((e,t)=>{console.log("websocket关闭"),r.default("ws","info",`连接关闭！code: ${e}，message: ${t}`),this.reconnect()})),e.onmessage=({data:e})=>s(this,void 0,void 0,(function*(){var n,s,i,o,a,r,d;const c=JSON.parse(e.toString());if(c.data.code===u.CodeEnum.success)return void l.getSession(c);const f={message:c,targetQQ:String(null===(i=null===(s=null===(n=c)||void 0===n?void 0:n.data)||void 0===s?void 0:s.sender)||void 0===i?void 0:i.id),text:null===(d=null===(r=null===(a=null===(o=c)||void 0===o?void 0:o.data)||void 0===a?void 0:a.messageChain)||void 0===r?void 0:r.find((e=>"Plain"===e.type)))||void 0===d?void 0:d.text};for(let e of Object.keys(t.EventFlow)){const n=t.EventFlow[e](f);n instanceof Promise&&(yield n)}})),d.WSInstance=e,e}static reconnect(){d.reconnection||(r.default("ws","info",`正在重连${++d.reConnectCount}次`),d.reConnectCount>=10?r.default("ws","error","重连超时"):(d.reconnection=!0,setTimeout((()=>{d.createWS(),d.reconnection=!1}),2e3)))}}d.reConnectCount=0,t.default=d.getWS()},178:function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=s(n(461));t.default=class{constructor(e){this.msg=e,this.sendMessageList=[]}at(e,t=""){return this.sendMessageList.push({methodName:"at",params:[e,t],method:()=>{this.msg.content.messageChain.push({type:"At",target:e,display:t})}}),this}atAll(){return this.sendMessageList.push({methodName:"atAll",params:[],method:()=>{this.msg.content.messageChain.push({type:"AtAll"})}}),this}face(e,t){return e||t?(this.sendMessageList.push({methodName:"face",params:[e,t],method:()=>{this.msg.content.messageChain.push({type:"Face",faceId:e,name:t})}}),this):this}plain(e){return this.sendMessageList.push({methodName:"plain",params:[e],method:()=>{this.msg.content.messageChain.push({type:"Plain",text:e})}}),this}image(e){const{imageId:t,url:n,path:s,base64:i}=e;return t||n||!s||i?(this.sendMessageList.push({methodName:"image",params:[e],method:()=>{this.msg.content.messageChain.push({type:"Image",imageId:t,url:n,path:s,base64:i})}}),this):this}flashImage(e){const{imageId:t,url:n,path:s,base64:i}=e;return t||n||!s||i?(this.sendMessageList.push({methodName:"flashImage",params:[e],method:()=>{this.msg.content.messageChain.push({type:"FlashImage",imageId:t,url:n,path:s,base64:i})}}),this):this}poke(e){return this.sendMessageList.push({methodName:"poke",params:[e],method:()=>{this.msg.content.messageChain.push({type:"Poke",name:e})}}),this}dice(e){return this.sendMessageList.push({methodName:"dice",params:[e],method:()=>{this.msg.content.messageChain.push({type:"Dice",value:e})}}),this}exec(){this.sendMessageList.forEach((e=>{e.method()})),i.default.send(JSON.stringify(this.msg)),this.sendMessageList=[]}}},391:function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(372),o=s(n(178)),a=s(n(116));t.default=new class{constructor(){}send(e,...t){let n={syncId:"-1",command:e,content:null};switch(e){case"sendGroupMessage":case"sendFriendMessage":return n.content={sessionKey:i.getSession(),target:t[0],messageChain:[]},new o.default(n);case"sendTempMessage":return n.content={sessionKey:i.getSession(),qq:t[0],group:t[1],messageChain:[]},new o.default(n);case"sendNudge":return void(n.content={sessionKey:i.getSession(),target:t[0],subject:t[1],kind:t[2]});case"recall":return void(n.content={sessionKey:i.getSession(),target:t[0]})}}get(e){return new a.default(e)}}},139:e=>{"use strict";e.exports=require("@reduxjs/toolkit")},349:e=>{"use strict";e.exports=require("dayjs")},455:e=>{"use strict";e.exports=require("log4js")},619:e=>{"use strict";e.exports=require("mongoose")},622:e=>{"use strict";e.exports=require("path")},906:e=>{"use strict";e.exports=require("reflect-metadata")},439:e=>{"use strict";e.exports=require("ws")}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var o=t[s]={exports:{}};return e[s].call(o.exports,o,o.exports,n),o.exports}(()=>{"use strict";n(906),n(40),n(461),n(903)})()})();